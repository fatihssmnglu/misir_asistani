{% extends 'base.html' %}
{% block title %}Yeni Tarla Ekle{% endblock %}
{% block content %}

<div class="container mt-4">
  <div class="card shadow-sm p-4">
    <h3 class="text-center mb-3">ğŸŒ¾ Yeni Tarla Ekle</h3>

    <!-- ğŸ—ºï¸ Harita -->
    <div id="map-wrapper" class="mb-3">
      <div id="map"></div>
    </div>

    <!-- ğŸ“ Konum Bul Butonu -->
    <div class="text-center mb-4">
      <button type="button" id="locateBtn" class="btn btn-outline-success px-4 py-2">
        ğŸ“ Åu Anki Konumumu Bul
      </button>
    </div>

    <!-- ğŸ§¾ Form -->
    <form id="fieldForm" method="POST">
      {% csrf_token %}
      {{ form.as_p }}

      <!-- ğŸ’¾ Kaydet Butonu -->
      <button id="saveBtn" type="submit" class="btn btn-success w-100 mt-3" disabled>
        ğŸ’¾ Kaydet
      </button>
    </form>
  </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const latInput = document.getElementById("id_lat");
  const lonInput = document.getElementById("id_lon");
  const villageSelect = document.getElementById("id_village");
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const form = document.getElementById("fieldForm");
  const saveBtn = document.getElementById("saveBtn");

  // ğŸ—ºï¸ Harita AyarlarÄ±
  // ğŸ—ºï¸ Harita AyarlarÄ± (Google Uydu)
const map = L.map('map').setView([39.0, 35.0], 6);
L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a> katkÄ±da bulunanlar'
}).addTo(map);

  

  let marker = null;

  // ğŸ“ Åu Anki Konumu Bul
  document.getElementById("locateBtn").addEventListener("click", () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        updateMarker(lat, lon);
        map.setView([lat, lon], 14);
        latInput.value = lat.toFixed(6);
        lonInput.value = lon.toFixed(6);
        reverseGeocode(lat, lon);
        checkFormFilled();
      }, err => alert("Konum alÄ±namadÄ±: " + err.message), { enableHighAccuracy: true });
    } else {
      alert("TarayÄ±cÄ±n konum servisini desteklemiyor!");
    }
  });

  // ğŸ–±ï¸ Haritaya TÄ±klama ile Konum SeÃ§me
  map.on("click", (e) => {
    const { lat, lng } = e.latlng;
    updateMarker(lat, lng);
    latInput.value = lat.toFixed(6);
    lonInput.value = lng.toFixed(6);
    reverseGeocode(lat, lng);
    checkFormFilled();
  });

  // Marker GÃ¼ncelle
  function updateMarker(lat, lon) {
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lon], {
      icon: L.icon({
        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',
        iconSize: [32, 32]
      })
    }).addTo(map).bindPopup("ğŸ“ SeÃ§ilen Konum").openPopup();
  }

  // ğŸŒ Reverse Geocode + KÃ¶y Ekleme
  function reverseGeocode(lat, lon) {
    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=12&addressdetails=1`)
      .then(res => res.json())
      .then(data => {
        const place = data.address;
        const villageName = place.village || place.town || place.city_district || place.suburb || "Bilinmeyen KÃ¶y";
        console.log("Bulunan kÃ¶y:", villageName);

        // KÃ¶yÃ¼ veritabanÄ±na ekle (yoksa)
        fetch("/add_village_if_not_exists/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken
          },
          body: JSON.stringify({ name: villageName })
        })
        .then(res => res.json())
        .then(data => {
          if (data.id) {
            let exists = false;
            for (let option of villageSelect.options) {
              if (option.text.toLowerCase() === data.name.toLowerCase()) {
                exists = true;
                villageSelect.value = option.value;
                break;
              }
            }
            if (!exists) {
              const opt = new Option(data.name, data.id, true, true);
              villageSelect.add(opt);
            }
          }
          checkFormFilled();
        });
      })
      .catch(err => console.error("KÃ¶y bulunamadÄ±:", err));
  }

  // âœ… Form Doldurma KontrolÃ¼
  const inputs = form.querySelectorAll("input, select, textarea");
  function checkFormFilled() {
    let allFilled = true;
    inputs.forEach(input => {
      if (input.type !== "hidden" && !input.value.trim()) {
        allFilled = false;
      }
    });
    saveBtn.disabled = !allFilled;
  }

  inputs.forEach(input => {
    input.addEventListener("input", checkFormFilled);
    input.addEventListener("change", checkFormFilled);
  });

  form.addEventListener("submit", function(e) {
    if (saveBtn.disabled) {
      e.preventDefault();
      alert("âš ï¸ LÃ¼tfen tÃ¼m alanlarÄ± doldur.");
    }
  });

  // Harita boyutu dÃ¼zeltmesi
  setTimeout(() => map.invalidateSize(), 800);
});
</script>

<style>
#map-wrapper {
  width: 100%;
  height: 400px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
}

#map {
  width: 100%;
  height: 100%;
}

.card {
  border-radius: 15px;
  background: #ffffffd9;
}

.btn {
  border-radius: 50px;
  font-weight: 500;
}

form label {
  font-weight: 500;
  color: #1b5e20;
}

#saveBtn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>

{% endblock %}
